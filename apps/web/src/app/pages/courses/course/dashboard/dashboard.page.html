<ng-container *ngIf="context.course as course">
  <nz-row [nzGutter]="[24, 24]" nzAlign="top">
    <nz-col nzXs="24" nzSm="24" nzMd="18" nzLg="18" nzXl="18">
      <header id="tuto-course-dashboard-header">
        <ui-search-bar [searchbar]="searchbar" id="tuto-course-search-bar">
          <ng-template let-context> {{ context }}</ng-template>
        </ui-search-bar>
        <button
          *ngIf="course.permissions?.update && sections.length"
          nz-button
          nzType="primary"
          nzShape="round"
          (click)="addSection(sections[sections.length - 1])"
          id="tuto-course-add-section-button"
        >
          Ajouter une section
        </button>
        <button
          *ngIf="context.course?.permissions?.update && viewMode.mode === 'table'"
          nz-button
          nzType="primary"
          nzShape="round"
          [queryParamsHandling]="'merge'"
          [routerLink]="['/activities/create']"
          [queryParams]="{ course: course.id }"
          id="tuto-course-add-activity-table-button"
        >
          Ajouter une activité
        </button>
        <course-csv-download-button
          *ngIf="context.course?.permissions?.update"
          [activities]="activities"
          [name]="course.name"
          type="course"
          [courseId]="course.id"
          id="tuto-course-csv-download"
        />
        <div class="spacer"></div>
        <ui-view-mode
          #viewMode
          storageKey="course.view-mode"
          defaultMode="cards"
          [modes]="['cards', 'table']"
          id="tuto-course-view-mode"
        />
      </header>
      <div id="tuto-course-dashboard-content">
        <ng-container *ngIf="sections.length; else noSections">
          <ng-container [ngSwitch]="viewMode.mode">
            <ng-container *ngSwitchCase="'cards'">
              <nz-collapse nzGhost id="tuto-course-sections-container">
                <nz-collapse-panel
                  *ngFor="let item of sectionWithActivities; trackBy: trackSection"
                  [nzActive]="true"
                  [nzHeader]="header"
                  [nzExtra]="extra"
                  class="tuto-course-section-panel"
                  [id]="'tuto-course-section-' + item.section.id"
                >
                  <ng-template #header>
                    <span
                      nz-typography
                      [nzEditable]="course.permissions?.update"
                      [nzContent]="item.section.name"
                      (nzContentChange)="renameSection(item.section, $event)"
                      (click)="$event.stopPropagation()"
                      class="tuto-course-section-title"
                    >
                    </span>
                  </ng-template>
                  <ng-template #extra>
                    <button
                      *ngIf="context.course?.permissions?.update"
                      class="add-activity"
                      nz-button
                      nzType="primary"
                      nzShape="round"
                      nzSize="small"
                      [routerLink]="['/activities/create']"
                      [queryParams]="{
                        course: item.section.courseId,
                        section: item.section.id
                      }"
                      id="tuto-course-add-activity-button"
                      class="tuto-course-add-activity-button"
                    >
                      Ajouter une activité
                    </button>
                    <app-course-section-actions
                      *ngIf="course.permissions?.update"
                      [section]="item.section"
                      [sectionCount]="sections.length"
                      (moveUp)="moveUpSection(item.section)"
                      (moveDown)="moveDownSection(item.section)"
                      (insertBelow)="addSection(item.section)"
                      (edit)="editModeOn(item)"
                      (save)="saveSection(item)"
                      (remove)="deleteSection(item.section)"
                      [nbActivities]="numberOfActivities(item.section)"
                      id="tuto-course-section-actions"
                      class="tuto-course-section-actions"
                    />
                  </ng-template>
                  <course-activity-grid
                    [items]="item.activities"
                    [editmode]="item.editMode"
                    class="tuto-course-activities-grid"
                  >
                    <ng-container *ngTemplateOutlet="noActivities; context: { $implicit: item.section }" />
                  </course-activity-grid>
                </nz-collapse-panel>
              </nz-collapse>
            </ng-container>
            <ng-container *ngSwitchCase="'table'">
              <course-activity-table
                [activities]="flattenedActivities"
                [sections]="sections"
                id="tuto-course-activities-table"
              />
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
    </nz-col>
    <nz-col nzXs="24" nzSm="24" nzMd="6" nzLg="6" nzXl="6">
      <aside id="tuto-course-statistics">
        <nz-row [nzGutter]="[24, 24]">
          <nz-col nzSpan="24">
            <ui-statistic-card
              nzIcon="line-chart"
              ribbonColor="#f39c12"
              description="Avancement sur les activités"
              valueSuffix="%"
              [value]="course.statistic?.progression ?? 0"
              id="tuto-course-stat-progression"
            />
          </nz-col>
          <nz-col nzSpan="24">
            <ui-statistic-card
              nzIcon="clock-circle"
              ribbonColor="#349d55"
              description="Temps passé sur les activités"
              [value]="course.statistic?.timeSpent ?? 0 | duration"
              id="tuto-course-stat-time"
            />
          </nz-col>
          <nz-col nzSpan="24">
            <ui-statistic-card
              nzIcon="team"
              ribbonColor="#8e44ad"
              description="Enseignants"
              [value]="course.statistic?.teacherCount ?? 0"
              id="tuto-course-stat-teachers"
            />
          </nz-col>
          <nz-col nzSpan="24">
            <ui-statistic-card
              nzIcon="team"
              ribbonColor="#7f8c8d"
              description="Élèves"
              [value]="course.statistic?.studentCount ?? 0"
              id="tuto-course-stat-students"
            />
          </nz-col>
        </nz-row>
      </aside>
    </nz-col>
  </nz-row>
</ng-container>

<ng-template #noSections>
  <nz-empty [nzNotFoundContent]="noSectionsContent" [nzNotFoundFooter]="noSectionsFooter" id="tuto-course-no-sections">
    <ng-template #noSectionsContent>
      Ce cours ne contient aucune section. Les sections permettent d'organiser le contenu du cours en thématiques.
    </ng-template>
    <ng-template #noSectionsFooter>
      <button
        *ngIf="context.course?.permissions?.update"
        nz-button
        nzType="primary"
        (click)="addSection()"
        id="tuto-course-add-first-section-button"
      >
        Ajouter une section
      </button>
    </ng-template>
  </nz-empty>
</ng-template>

<ng-template let-section #noActivities>
  <nz-empty [nzNotFoundContent]="noActivitiesContent" id="tuto-course-no-activities">
    <ng-template #noActivitiesContent> Cette section ne contient aucune activité. </ng-template>
  </nz-empty>
</ng-template>
