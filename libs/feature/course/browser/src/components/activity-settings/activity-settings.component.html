<div class="activity-settings-container">
  <div class="color-section">
    <div class="section-header">
      <i nz-icon nzType="bg-colors" nzTheme="outline"></i>
      <h3>Apparence de l'activit√©</h3>
    </div>
    <course-color-picker
      [hue]="currentHue"
      [activityColors]="activityColors"
      (hueChange)="onHueChange($event)"
    ></course-color-picker>
  </div>

  <!-- Section P√©riodes d'acc√®s -->
  <div class="access-periods-section">
    <div class="section-header">
      <i nz-icon nzType="clock-circle" nzTheme="outline"></i>
      <h3>P√©riodes d'acc√®s</h3>
      <span class="section-subtitle">D√©finissez quand et pour qui cette activit√© est accessible</span>
    </div>

    <!-- Zone de drag & drop -->
    <div
      class="access-periods-container"
      cdkDropList
      (cdkDropListDropped)="onDropAccessPeriod($event)"
      [cdkDropListData]="accessPeriods"
    >
      @if (accessPeriods.length === 0) {
      <div class="empty-state">
        <!-- Affichage des dates actuelles de l'activit√© -->
        <div class="current-activity-dates">
          <div class="dates-info">
            <div class="date-item">
              <i nz-icon nzType="calendar" nzTheme="outline"></i>
              <div class="date-content">
                <span class="date-label">Ouverture</span>
                <span class="date-value">
                  {{ activity.openAt | date : "d MMM yyyy, HH'h'mm" : '' : 'fr-FR' }}
                  <ng-container *ngIf="!activity.openAt">Aucune date d√©finie</ng-container>
                </span>
              </div>
            </div>

            <div class="date-separator">‚Üí</div>

            <div class="date-item">
              <i nz-icon nzType="calendar" nzTheme="outline"></i>
              <div class="date-content">
                <span class="date-label">Fermeture</span>
                <span class="date-value">
                  {{ activity.closeAt | date : "d MMM yyyy, HH'h'mm" : '' : 'fr-FR' }}
                  <ng-container *ngIf="!activity.closeAt">Aucune date d√©finie</ng-container>
                </span>
              </div>
            </div>
          </div>

          <div class="access-info">
            <i nz-icon nzType="team" nzTheme="outline"></i>
            <span>Tous les membres du cours ont acc√®s √† cette activit√© aux dates indiqu√©es ci-dessus.</span>
          </div>
        </div>

        <!-- Bouton pour cr√©er la premi√®re p√©riode -->
        <button
          nz-button
          nzType="primary"
          nz-popconfirm
          [nzPopconfirmTitle]="confirmFirstPeriod"
          nzPopconfirmPlacement="top"
          (nzOnConfirm)="newAccessPeriod()"
          class="empty-action-btn"
        >
          <i nz-icon nzType="plus"></i>
          Cr√©er la premi√®re p√©riode
        </button>
      </div>
      } @else { @for (period of accessPeriods; track period; let i = $index) {
      <div class="access-period-item" cdkDrag [cdkDragData]="period">
        <course-restriction-manager
          [activity]="activity"
          [courseGroups]="courseGroups"
          [courseMembers]="courseMembers"
          [restrictions]="period.restriction"
          [index]="i"
          (sendRestrictions)="updateRestriction(i, $event)"
        ></course-restriction-manager>
      </div>
      } }
    </div>

    <!-- Bouton d'ajout -->
    @if (accessPeriods.length > 0) {
    <div class="add-period-section">
      <button nz-button nzType="dashed" nzBlock (click)="newAccessPeriod()" class="add-period-btn">
        <i nz-icon nzType="plus"></i>
        Ajouter une nouvelle p√©riode d'acc√®s
      </button>
      <div class="add-period-hint">
        <i nz-icon nzType="info-circle" nzTheme="outline"></i>
        <span>Les p√©riodes peuvent se chevaucher. Glissez-d√©posez pour r√©organiser.</span>
      </div>
    </div>
    }
  </div>

  <!-- Actions -->
  <div class="actions-section">
    <div class="secondary-actions">
      <div class="action-group">
        <h4>Gestion de l'activit√©</h4>
        <div class="action-buttons">
          <button
            nz-button
            nzDanger
            nz-popconfirm
            [nzPopconfirmTitle]="confirmClose"
            nzPopconfirmPlacement="top"
            (nzOnConfirm)="close()"
            class="action-btn"
          >
            <i nz-icon nzType="stop" nzTheme="outline"></i>
            Fermer l'activit√©
          </button>

          <button
            nz-button
            nz-popconfirm
            [nzPopconfirmTitle]="confirmReopen"
            nzPopconfirmPlacement="top"
            (nzOnConfirm)="reopenForAll()"
            class="action-btn"
          >
            <i nz-icon nzType="play-circle" nzTheme="outline"></i>
            Rouvrir pour tous
          </button>
        </div>
      </div>

      <div class="action-group">
        <h4>Actions avanc√©es</h4>
        <div class="action-buttons">
          <button
            nz-button
            nzDanger
            nz-popconfirm
            [nzPopconfirmTitle]="confirmReload"
            nzPopconfirmPlacement="top"
            (nzOnConfirm)="reload()"
            class="action-btn"
          >
            <i nz-icon nzType="reload" nzTheme="outline"></i>
            Recharger
          </button>

          <button
            nz-button
            nzDanger
            nzType="primary"
            nz-popconfirm
            [nzPopconfirmTitle]="confirmDelete"
            nzPopconfirmPlacement="top"
            (nzOnConfirm)="delete()"
            class="action-btn danger"
          >
            <i nz-icon nzType="delete" nzTheme="outline"></i>
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates de confirmation -->
  <ng-template #confirmClose>
    <div class="confirm-content">
      <h4>Fermer l'activit√©</h4>
      <p>Les √©tudiants ne pourront plus acc√©der √† cette activit√©.</p>
    </div>
  </ng-template>

  <ng-template #confirmReopen>
    <div class="confirm-content">
      <h4>Rouvrir pour tous</h4>
      <p>La date de fin sera automatiquement supprim√©e.</p>
    </div>
  </ng-template>

  <ng-template #confirmReload>
    <div class="confirm-content">
      <h4>Recharger l'activit√©</h4>
      <p>L'activit√© sera remplac√©e par sa derni√®re version publi√©e.</p>
    </div>
  </ng-template>

  <ng-template #confirmDelete>
    <div class="confirm-content">
      <h4>Supprimer l'activit√©</h4>
      <p><strong>Cette action est irr√©versible.</strong></p>
    </div>
  </ng-template>

  <ng-template #confirmFirstPeriod>
    <div class="confirm-content">
      <div class="warning-header">
        <i nz-icon nzType="exclamation-circle" nzTheme="fill" style="color: #faad14; margin-right: 8px"></i>
        <h4 style="margin: 0; color: #faad14">Attention - Premi√®re p√©riode d'acc√®s</h4>
      </div>

      <div class="warning-body" style="margin-top: 12px">
        <p><strong>Actuellement :</strong> Tous les membres du cours ont acc√®s √† cette activit√© aux dates indiqu√©es.</p>

        <p><strong>En ajoutant cette p√©riode :</strong></p>
        <ul style="margin: 8px 0; padding-left: 20px">
          <li style="margin-bottom: 4px">Seuls les utilisateurs/groupes sp√©cifi√©s auront acc√®s</li>
          <li style="margin-bottom: 4px">Les autres membres perdront l'acc√®s √† l'activit√©</li>
          <li style="margin-bottom: 4px">Vous pourrez modifier ces restrictions plus tard</li>
        </ul>

        <div
          class="tip"
          style="
            background: var(--brand-background-components);
            border: 1px solid #b7eb8f;
            border-radius: 6px;
            padding: 8px;
            margin-top: 12px;
            font-size: 12px;
          "
        >
          <strong style="color: var(--brand-text-primary)">üí° Conseil :</strong> Pour que les membres non sp√©cifi√©s
          gardent l'acc√®s, cr√©ez une p√©riode suppl√©mentaire avec la r√®gle "Tous les autres".
        </div>
      </div>
    </div>
  </ng-template>
</div>
