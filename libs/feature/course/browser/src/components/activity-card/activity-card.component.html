<ng-container *ngIf="item | courseActivityState as activityState">
  <mat-card>
    <div class="card-header" [style.background-color]="color"></div>
    <mat-card-header>
      <mat-card-title>
        <a
          *ngIf="item.isChallenge"
          nz-button
          nzType="link"
          [routerLink]="['/courses', item.courseId, 'challenges']"
          [queryParams]="{
            activity: item.id
          }"
          queryParamsHandling="merge"
        >
          <span nz-tooltip="Afficher les résultats du challenge" nz-icon nzType="trophy" nzTheme="twotone"></span>
        </a>
        {{ item.title }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="ribbon-container">
        <nz-ribbon [nzText]="activityState.label" [nzColor]="activityState.color"></nz-ribbon>
      </div>
      <div class="card-content">
        <div class="circle-progression-container">
          <nz-progress
            *ngIf="item.permissions.answer"
            nz-tooltip="Avancement sur les exercices"
            [nzPercent]="item.progression"
            nzType="circle"
            nzStrokeWidth="8"
            [nzWidth]="150"
            [nzStrokeColor]="color"
            [nzFormat]="progressionTemplate"
            nzStatus="normal"
          />
        </div>
        <div class="dates-container">
          <div class="date-item">
            <span>
              {{ item.openAt | date : "d MMM yyyy, HH'h'mm" : '' : 'fr-FR' }}
              <ng-container *ngIf="!item.openAt"> - </ng-container>
            </span>
            <span class="date-label"> Ouverture </span>
          </div>
          <div class="separator"></div>
          <div class="date-item">
            <span>
              {{ item.closeAt | date : "d MMM yyyy, HH'h'mm" : '' : 'fr-FR' }}
              <ng-container *ngIf="!item.closeAt"> - </ng-container>
            </span>
            <span class="date-label"> Fermeture </span>
          </div>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <div>
        <a
          *ngIf="item.permissions.answer"
          nz-tooltip="Lancer l'activité"
          nz-button
          nzShape="round"
          nzType="primary"
          target="_blank"
          [routerLink]="['/player/activity', item.id]"
          class="action-button"
        >
          <mat-icon fontSet="material-icons">play_arrow</mat-icon>
          Lancer
        </a>
        <button
          *ngIf="item.permissions.viewResource"
          nz-tooltip="Ouvrir l'éditeur de l'activité"
          nz-button
          nzShape="round"
          (click)="openTab(editorUrl)"
          class="action-button"
        >
          <mat-icon>edit</mat-icon>
          Editer
        </button>
      </div>
      <div>
        <button
          *ngIf="item.permissions.update || item.permissions.viewStats"
          class="more-button"
          nz-button
          nzType="text"
          nzShape="round"
          (click)="$event.stopPropagation()"
          nz-dropdown
          nzTrigger="click"
          [nzDropdownMenu]="moreActions"
          nzPlacement="topLeft"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
        <nz-dropdown-menu #moreActions="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item *ngIf="item.permissions.viewStats" [routerLink]="['/activities', item.courseId, item.id]">
              Statistiques
            </li>
            <li nz-menu-item>
              <course-csv-download-button
                *ngIf="item.permissions.update"
                [activities]="[item]"
                [name]="item.title"
                type="activity"
                [courseId]="item.courseId"
              />
            </li>
            <li nz-menu-item *ngIf="item.permissions.viewResource" [routerLink]="['/resources', item.resourceId]">
              Ouvrir la ressource associée
            </li>
            <li nz-menu-item *ngIf="item.permissions.update" (click)="modal.open()">Paramètres</li>
          </ul>
        </nz-dropdown-menu>
      </div>
    </mat-card-actions>
  </mat-card>
</ng-container>
<ui-modal-drawer size="large" [title]="item.title" #modal>
  <ng-template>
    <course-activity-settings [(activity)]="item" />
  </ng-template>
</ui-modal-drawer>
<ng-template #progressionTemplate>
  <div class="progression">
    <span class="progression-value">{{ item.progression }}</span>
    <span class="progression-unit">%</span>
  </div>
  <div class="progression-exercises">
    {{ completedExercises }}/{{ item.exerciseCount }} terminé{{ completedExercises > 1 ? 's' : '' }}
  </div>
</ng-template>
