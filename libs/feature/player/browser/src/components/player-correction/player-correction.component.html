<mat-drawer-container>
  <mat-drawer mode="side" opened #drawer>
    <nav>
      <img class="logo" src="assets/images/logo/platon.svg" alt="Logo PLaTon" [routerLink]="'/dashboard'" />
      <h2>Corrections</h2>
      <nz-collapse class="panel-wrapper" [nzBordered]="false">
        @for (entry of activityExercisesMap.entries(); track entry[0]) {
        <nz-collapse-panel
          [nzHeader]="entry[1].name"
          [nzActive]="activityId ? entry[0] === activityId : entry[0] === activityExercisesMap.keys().next().value"
        >
          <ng-container *ngFor="let ex of entry[1].map.entries()">
            <button
              (click)="onChooseGroup(ex[1])"
              mat-button
              class="nav-link"
              [class.active]="ex[0] === currentGroup?.exerciseId"
            >
              <div class="nav-link-content">
                <div class="icon-container">
                  <mat-icon [style.color]="ex[1].graded ? 'green' : 'white'">
                    {{ ex[1].graded ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                </div>
                <div class="exercise-name">{{ ex[1].exerciseName }}</div>
              </div>
            </button>
          </ng-container>
        </nz-collapse-panel>
        }
      </nz-collapse>
    </nav>
  </mat-drawer>
  <mat-drawer-content>
    <div *ngIf="!resumeMode">
      <mat-toolbar class="toolbar">
        <button mat-icon-button (click)="onChoosePreviousUserExercise()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <nz-select
          class="student-name"
          [ngModel]="currentUser?.id"
          (ngModelChange)="loadUserExercise($event)"
          [nzOptions]="userOptions"
          [@swipeAnimation]="animationState"
        >
        </nz-select>
        <button mat-icon-button (click)="onChooseNextUserExercise()">
          <mat-icon>chevron_right</mat-icon>
        </button>

        <div class="setting-button">
          <button
            mat-fab
            id="summarizeButton"
            extended
            *ngIf="exerciseCorrected.size === exercises.length"
            (click)="resumeMode = !resumeMode"
          >
            <mat-icon>summarize</mat-icon>
            Résumé
          </button>
          <button mat-icon-button (click)="isSettingsModalOpen = true">
            <mat-icon>settings</mat-icon>
          </button>
          <nz-modal
            [(nzVisible)]="isSettingsModalOpen"
            nzTitle="Paramètres"
            (nzOnCancel)="isSettingsModalOpen = false"
            (nzOnOk)="isSettingsModalOpen = false"
          >
            <ng-container *nzModalContent>
              <div style="padding: 1rem; text-align: center">
                <nz-select
                  [nzOptions]="[
                    { label: 'Partir de la note donnée par PLaTon', value: 'platon' },
                    { label: 'Partir de la note maximale', value: 'max' },
                    { label: 'Partir de la note minimale', value: 'min' }
                  ]"
                  [(ngModel)]="selectedGradeOption"
                  (ngModelChange)="loadAnswers(this.currentExercise!)"
                >
                </nz-select>
              </div>
            </ng-container>
          </nz-modal>
        </div>
      </mat-toolbar>
      <main style="padding: 0.5rem">
        <nz-row style="height: 95vh">
          <nz-col nzSpan="17" class="left-col-wrapper">
            <player-review #player [players]="answers" [reviewMode]="true" [canComment]="true" />
          </nz-col>
          <nz-col nzSpan="7" class="mid-col-wrapper">
            <mat-card #GradeCard>
              <mat-card-content style="display: flex; flex-direction: column; align-items: center">
                <nz-progress
                  [nzPercent]="(exerciseCorrected.size / exercises.length) * 100"
                  [nzShowInfo]="exerciseCorrected.size === exercises.length"
                  [nzStrokeColor]="{ '0%': '#ff008c', '100%': '#ff6f00' }"
                  nzStatus="active"
                  style="width: 100%"
                ></nz-progress>
                <span style="font-size: 0.7rem"
                  >{{ exerciseCorrected.size }} évalué{{ exerciseCorrected.size > 1 ? 's' : '' }} sur
                  {{ exercises.length }}</span
                >

                <nz-divider nzPlain nzText="Note attribuée" class="divider"></nz-divider>

                <div>
                  <h1 style="margin: 0">
                    {{ correctedGrade }} / 100
                    <mat-icon
                      [style.color]="
                        exerciseCorrected.has(this.currentExercise?.exerciseSessionId || '') ? 'green' : 'white'
                      "
                    >
                      {{ exerciseCorrected.has(currentExercise?.exerciseSessionId || '') ? 'check_circle' : 'cancel' }}
                    </mat-icon>
                  </h1>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- <div class="grade-wrapper">
            <ui-statistic-card
              matIcon="check_circle"
              ribbonColor="#8e44ad"
              description="Note attribuées à l'élève"
              [value]="correctedGrade ?? 0"
              shouldBePositive
              [edit]="true"
              (valueChanged)="onSaveGrade()"
            />
          </div>
          -->

            <correction-label
              [answers]="answers"
              [activityId]="currentActivityId"
              [currentExercise]="currentExercise"
              [navigationExerciseId]="currentGroup?.exerciseId"
              (currentLabelsChange)="onCurrentLabelsChange($event)"
              (totalGradeChange)="onTotalGradeChange($event)"
            />

            <player-comments *ngIf="answers.length > 0" [canComment]="true" [answers]="answers" />
          </nz-col>
          <!-- <nz-col nzSpan="1">
          <nz-button-group nzSize="small" class="button-wrapper">
            <button
              nz-button
              nzBlock
              *ngFor="let i of [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]"
              (click)="setGradeOnClick($event, i)"
            >
              {{ i }}
            </button>
          </nz-button-group>
        </nz-col> -->
        </nz-row>
      </main>
      <!--
    <main>
      <nz-segmented
        #segmented
        [ngModel]="selectedTabIndex"
        (ngModelChange)="onChooseTab($event)"
        [nzOptions]="['Corrections en attente', 'Corrections terminées']"
      />
      <ng-container *ngIf="exercises.length as exerciseCount; else noExercises">
        <ng-container>
          <nz-ribbon *ngIf="answers.length as answerCount; else noAnswers" [nzText]="ribbon">
            <ng-template #ribbon>
              Exercice : {{ selectedExerciseIndex + 1 }}/{{ exerciseCount }}&nbsp; Réponse :
              {{ player.currentAttemptIndex + 1 }}/{{ answerCount }}
            </ng-template>
            <h1>aaaaa</h1>
            <player-review #player [players]="answers" [reviewMode]="true" [canComment]="true" class="sized" />
            <h1>aaaaa</h1>
          </nz-ribbon>
          <footer *ngIf="currentExercise">
            <h3>Note grader ({{ currentExercise.grade }})</h3>
            <nz-slider
              [disabled]="true"
              [(ngModel)]="currentExercise.grade"
              [nzMarks]="{ '-1': '-1', '100': '100' }"
              nzMin="-1"
              nzMax="100"
            />
            <h3>Note ajustée ({{ correctedGrade }})</h3>
            <nz-slider [nzMarks]="{ '-1': '-1', '100': '100' }" [(ngModel)]="correctedGrade" nzMin="-1" nzMax="100" />
            <mat-toolbar>
              <button (click)="onSaveGrade()" mat-raised-button color="primary">Enregistrer</button>
              <button *ngIf="selectedExerciseIndex > 0" mat-raised-button (click)="onChoosePreviousExercise()">
                <mat-icon>arrow_back</mat-icon>
                Utilisateur précédent
              </button>
              <button
                *ngIf="selectedExerciseIndex < exerciseCount - 1"
                mat-raised-button
                (click)="onChooseNextExercise()"
              >
                <mat-icon>arrow_forward</mat-icon>
                Utilisateur suivant
              </button>
            </mat-toolbar>
          </footer>
        </ng-container>
        <ng-template #noAnswers>
          <nz-ribbon [nzText]="ribbon">
            <ng-template #ribbon> Exercice : {{ selectedExerciseIndex + 1 }}/{{ exerciseCount }} </ng-template>
            <nz-empty [nzNotFoundContent]="content">
              <ng-template #content> L'élève n'a pas répondu à cet exercice </ng-template>
            </nz-empty>
          </nz-ribbon>
        </ng-template>
      </ng-container>
    </main>-->
    </div>
    <div *ngIf="resumeMode">
      <mat-toolbar class="toolbar">
        <div class="setting-button">
          <button
            mat-fab
            id="summarizeButton"
            extended
            *ngIf="exerciseCorrected.size === exercises.length"
            (click)="resumeMode = !resumeMode"
          >
            <mat-icon>summarize</mat-icon>
            Résumé
          </button>
          <button mat-icon-button>
            <mat-icon>settings</mat-icon>
          </button>
        </div>
      </mat-toolbar>
      <main style="padding: 0.5rem">
        <nz-row style="height: 95vh">
          <nz-col nzSpan="17" class="left-col-wrapper">
            <correction-resume-table
              [data]="correctionResumeList"
              [userMap]="userMap"
              [highlightedGrade]="highlightedGrade"
              (gradeAdjustmentChange)="onGradeAdjustmentChange($event)"
              (correctionsUpdated)="onCorrectionsResumeDone($event)"
            ></correction-resume-table>
          </nz-col>
          <nz-col nzSpan="7" class="mid-col-wrapper">
            <mat-card #GradeCard>
              <mat-card-content style="height: 25rem; padding: 0.5rem">
                <result-histogram [data]="correctionGrades" (highlightedValueChange)="highlightedGrade = $event" />
              </mat-card-content>
            </mat-card>
            <div class="statistic-wrapper">
              <ui-statistic-card
                matIcon="check_circle"
                ribbonColor="#8e44ad"
                description="Moyenne sur l'exercice"
                [value]="correctionGradesMean.toFixed(2)"
                shouldBePositive
              />
              <ui-statistic-card
                matIcon="check_circle"
                ribbonColor="#8e44ad"
                description="Écart-type sur l'exercice"
                [value]="standardDeviation.toFixed(2)"
                shouldBeZero
              />
            </div>

            <correction-label
              [answers]="answers"
              [activityId]="currentActivityId"
              [resumeMode]="true"
              [currentExercise]="currentExercise"
              [navigationExerciseId]="currentGroup?.exerciseId"
              (totalGradeChange)="onTotalGradeChange($event)"
              (labelGradeChange)="onLabelGradeChange($event)"
            />
          </nz-col>
        </nz-row>
      </main>
    </div>
  </mat-drawer-content>
</mat-drawer-container>

<ng-template #noExercises>
  <div [ngSwitch]="selectedTabIndex">
    <ng-container *ngSwitchCase="0">
      <ng-container [ngTemplateOutlet]="noPendings" />
    </ng-container>
    <ng-container *ngSwitchCase="1">
      <ng-container [ngTemplateOutlet]="noCorrections" />
    </ng-container>
  </div>
</ng-template>

<ng-template #noPendings>
  <nz-empty [nzNotFoundContent]="content">
    <ng-template #content>
      Félicitations, vous avez terminé toutes les corrections qui vous ont été attribuées sur l'exercice
      <b> {{ currentGroup?.exerciseName }} </b>!
    </ng-template>
  </nz-empty>
</ng-template>

<ng-template #noCorrections>
  <nz-empty [nzNotFoundContent]="content">
    <ng-template #content> Aucune correction disponible ! </ng-template>
  </nz-empty>
</ng-template>
