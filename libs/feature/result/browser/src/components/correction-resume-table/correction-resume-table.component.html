<!-- Action buttons for saving/resetting modifications -->
<div class="table-actions" *ngIf="hasUnsavedChanges">
  <div class="actions-info">
    <mat-icon>edit</mat-icon>
    <span>{{ getModificationCount() }} modification(s) en attente</span>
  </div>
  <div class="actions-buttons">
    <button mat-stroked-button color="warn" (click)="resetModifications()" title="Annuler toutes les modifications">
      <mat-icon>undo</mat-icon>
      Annuler
    </button>
    <button mat-flat-button color="primary" (click)="saveModifications()" title="Enregistrer toutes les modifications">
      <mat-icon>save</mat-icon>
      Enregistrer les modifications
    </button>
  </div>
</div>

<table mat-table [dataSource]="dataSource" matSort>
  <!-- Position Column -->
  <ng-container matColumnDef="userId">
    <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by Name">Étudiants</th>
    <td mat-cell *matCellDef="let sheet" [ngClass]="getStyle(sheet.correctedGrade ?? sheet.grade)">
      {{ userMap.get(sheet.userId)?.firstName ?? 'Inconnu' }} {{ userMap.get(sheet.userId)?.lastName ?? '' }}
    </td>
  </ng-container>

  <!-- Grade Column -->
  <ng-container matColumnDef="grade">
    <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by Grade">Note</th>
    <td mat-cell *matCellDef="let sheet" [ngClass]="getStyle(sheet.correctedGrade ?? sheet.grade)">
      <span [title]="gradeAdjustments.has(sheet.userId) ? 'Note ajustée: ' + getFinalGrade(sheet) : ''">
        {{ getGradeDisplayText(sheet) }}
      </span>
    </td>
  </ng-container>

  <!-- Labels Column -->
  <ng-container matColumnDef="labels">
    <th mat-header-cell *matHeaderCellDef>Labels</th>
    <td mat-cell *matCellDef="let sheet" [ngClass]="getStyle(sheet.correctedGrade ?? sheet.grade)">
      <ng-container *ngIf="sheet.labels.length > 0; else noLabels">
        <span *ngFor="let label of sheet.labels" class="label">
          {{ label.name }}
        </span>
      </ng-container>
      <ng-template #noLabels>
        <span class="no-labels">Aucun label</span>
      </ng-template>
    </td>
  </ng-container>

  <!-- Grade Adjustment Column -->
  <ng-container matColumnDef="adjustment">
    <th mat-header-cell *matHeaderCellDef>Ajustement</th>
    <td mat-cell *matCellDef="let sheet" [ngClass]="getStyle(sheet.correctedGrade ?? sheet.grade)">
      <input
        #adjustmentInput
        nz-input
        placeholder="+/-0"
        type="text"
        nzBorderless
        [value]="getAdjustmentValue(sheet)"
        [ngStyle]="getInputStyles(sheet)"
        (blur)="saveEditInput(sheet, adjustmentInput); $event.stopPropagation()"
        (keydown.enter)="adjustmentInput.blur()"
        (keydown.escape)="adjustmentInput.value = getAdjustmentValue(sheet); adjustmentInput.blur()"
        style="width: 80px; text-align: center"
        title="Saisir un ajustement (ex: +5, -3)"
      />
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
</table>
